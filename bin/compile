#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

build_dir=$1
env_dir=$3

cd $build_dir

ENV_FILE=$(cat $env_dir/ENV_FILE)

echo "---- Using secrets from $ENV_FILE"

gpg-agent --daemon

gpg --import $env_dir/PGP_PRIVATE_KEY_HEROKU

gpg --output $ENV_FILE --decrypt $ENV_FILE.gpg

if [ -f $ENV_FILE ]; then
  echo "---- Successfully decrypted $ENV_FILE.gpg"
else
  echo "---- Decryption failed!"
fi

echo KILLAGENT | gpg-connect-agent

echo "---- Decryption done!"

echo "---- Populate environment"

export $(egrep -v "^(#|\$)" $ENV_FILE | sed 's/ = /=/g' | xargs)

echo "---- Make environment available to succeeding build packs"

touch $HOME/profile

egrep -v "^(#|\$)" $ENV_FILE | sed 's/ = /=/g' | sed 's/^/export /g' >> $HOME/profile

echo "---- Creating env variables"

IFS=$'\n' # make newlines the only separator
for line in $(cat < "$ENV_FILE" | egrep -v "^(#|\$)"); do
  IFS=' = ' read -r -a array <<< "$line"
  echo "${array[1]}" >> "$env_dir/${array[0]}"
  IFS=$'\n'
done

cat $env_dir/SEE_BASEURL
